<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrupamento de Escolas por Proximidade</title>
    
    <!-- Configuração do Tailwind CSS com a nova cor principal -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              mainBlue: {
                50: '#eef2f7',
                100: '#dde5ed',
                300: '#a3b7d1',
                500: '#274e82', // A cor especificada
                600: '#234676',
                700: '#1e3d64',
                800: '#193352',
              }
            }
          }
        }
      }
    </script>
    <style>
        /* Define a fonte Inter */
        html { font-family: 'Inter', sans-serif; }

        /* Estilo para a caixa de mensagem/modal (no lugar de alert) */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #274e82; /* mainBlue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- Carregamento das bibliotecas JS necessárias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Biblioteca SheetJS para leitura de arquivos XLSX e XLS -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="message-container"></div>
    <div id="message-overlay" class="hidden message-box-overlay"></div>

    <div class="container mx-auto p-4 md:p-6">
        <!-- Título e Instruções (Cor atualizada para mainBlue-700) -->
        <header class="mb-4">
            <h1 class="text-3xl font-bold text-mainBlue-700 mb-1">Agrupamento de Escolas por Proximidade </h1>
            <p class="text-sm text-gray-500">
                Carregue sua lista de escolas para agrupá-las em Grupos de proximidade (raio de 5km) e pesquisar provedores por região.
            </p>
        </header>

        <!-- Seção de Upload e Status (Cor atualizada para mainBlue) -->
        <div class="bg-white p-4 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="w-full md:w-auto flex-grow">
                <label for="csvFileInput" class="block text-sm font-medium text-gray-700 mb-1">
                    1. Carregue sua lista de escolas (.xlsx ou .xls)
                </label>
                <input type="file" id="csvFileInput" accept=".xlsx,.xls" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-mainBlue-50 file:text-mainBlue-700 hover:file:bg-mainBlue-100" />
            </div>
            <div class="w-full md:w-auto md:min-w-[200px] text-right">
                <p id="statusMessage" class="text-sm font-medium text-gray-600">Aguardando arquivo...</p>
            </div>
        </div>
        
        <!-- Tab Navigation: Removida a aba de Provedor. A única aba é o Agrupamento. -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tabGroups" onclick="window.setActiveTab('groups')" class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 text-white bg-mainBlue-500 shadow-md">
                Grupos de Proximidade (5km)
            </button>
        </div>

        <!-- Container de Resultados (Grupos) -->
        <div id="resultsContainer" class="grid grid-cols-1 gap-6">
            <div id="initialPrompt" class="bg-white p-6 rounded-xl shadow-lg text-center text-gray-500">
                Carregue o arquivo XLSX para iniciar o agrupamento de escolas.
            </div>
        </div>
    </div>

    <script type="module">
        // Variáveis de ambiente
        const apiKey = "AIzaSyAjjgVH3Jgw8_ZOAtihB699dAlJXu6zSNo";
        const generateContentUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const MAX_DISTANCE_KM = 5; // Distância máxima para considerar escolas no mesmo Grupo (5 km)

        // Referências do DOM
        const csvFileInput = document.getElementById('csvFileInput');
        const statusMessage = document.getElementById('statusMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        const messageContainer = document.getElementById('message-container');
        const messageOverlay = document.getElementById('message-overlay');
        const tabGroups = document.getElementById('tabGroups'); // Renomeado

        let schoolData = [];
        let groupGroups = []; // Renomeado de clusterGroups
        // providerGroups foi removido
        let actualColumnNames = {};
        let activeTab = 'groups'; // Aba única

        // --- Funções de UI (Caixa de Mensagem) ---

        /**
         * Exibe uma caixa de mensagem customizada no centro da tela.
         */
        function showMessageBox(title, content, isLoading = false, customActionHtml = '') {
            messageContainer.innerHTML = '';
            const loadingHtml = isLoading ? '<span class="loading-spinner"></span>' : '';

            const boxHtml = `
                <div class="message-box bg-white rounded-xl p-6 w-full max-w-lg">
                    <h3 class="text-xl font-bold mb-3 text-mainBlue-700 flex items-center">
                        ${loadingHtml} ${title}
                    </h3>
                    <div class="text-sm text-gray-600 mb-4 max-h-96 overflow-y-auto" id="message-content">
                        ${content}
                    </div>
                    <div id="custom-action-area">
                        ${customActionHtml}
                    </div>
                    ${isLoading ? '' : '<button onclick="window.closeMessageBox()" class="w-full py-2 px-4 bg-mainBlue-500 text-white font-semibold rounded-lg shadow-md hover:bg-mainBlue-600 transition duration-200 mt-2">Fechar</button>'}
                </div>
            `;
            messageContainer.innerHTML = boxHtml;
            messageOverlay.classList.remove('hidden');
        }

        // Função global para fechar a caixa de mensagem
        window.closeMessageBox = () => {
            messageContainer.innerHTML = '';
            messageOverlay.classList.add('hidden');
        };

        /**
         * Atualiza o estilo da aba ativa (agora a única aba).
         */
        window.setActiveTab = (tabName) => {
            activeTab = tabName;
            
            // Define o estilo da aba única (Grupos)
            tabGroups.classList.remove('text-gray-700', 'hover:bg-white');
            tabGroups.classList.add('bg-mainBlue-500', 'text-white', 'shadow-md');

            renderResults();
        };

        // --- Lógica de Geometria e Agrupamento ---

        /**
         * Calcula a distância Haversine entre dois pontos em km.
         */
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em quilômetros
            const toRad = (value) => (value * Math.PI) / 180;

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distância em km
        }

        /**
         * Agrupa as escolas por proximidade usando a distância Haversine (DBSCAN simplificado).
         * Renomeado de clusterSchools para groupSchools.
         */
        function groupSchools(schools, maxDistanceKm) {
            const groups = []; // Renomeado de clusters
            const schoolsCopy = [...schools]; 

            while (schoolsCopy.length > 0) {
                const currentSchool = schoolsCopy.shift(); 
                
                const newGroup = { // Renomeado de newCluster
                    id: groups.length + 1,
                    municipality: currentSchool.municipality,
                    schools: [currentSchool]
                };

                let i = 0;
                while (i < schoolsCopy.length) {
                    const candidate = schoolsCopy[i];
                    
                    const distance = haversineDistance(
                        currentSchool.lat, currentSchool.lon, 
                        candidate.lat, candidate.lon
                    );

                    if (distance <= maxDistanceKm) {
                        newGroup.schools.push(candidate);
                        schoolsCopy.splice(i, 1); 
                    } else {
                        i++; 
                    }
                }
                groups.push(newGroup);
            }

            groups.sort((a, b) => {
                if (a.municipality < b.municipality) return -1;
                if (a.municipality > b.municipality) return 1;
                return b.schools.length - a.schools.length;
            });

            return groups;
        }

        // groupSchoolsByProvider foi removido

        // --- Lógica de Dados e Visualização de Grupos ---

        /**
         * Encontra o nome real de uma coluna no objeto de dados, tolerando variações de case e espaço.
         */
        function findActualKey(searchKey, school) {
            const keys = Object.keys(school);
            const normalizedSearchKey = searchKey.replace(/\s+/g, ' ').toLowerCase(); 

            for (const key of keys) {
                const normalizedKey = key.replace(/\s+/g, ' ').toLowerCase(); 

                if (normalizedKey.includes(normalizedSearchKey)) {
                    return key; 
                }
            }
            return null;
        }


        /**
         * Processa os dados de uma escola, garantindo que Lat/Long sejam números válidos.
         */
        function processSchool(school) {
            const latKey = actualColumnNames.LATITUDE;
            const lonKey = actualColumnNames.LONGITUDE;
            const nameKey = actualColumnNames.NAME;
            const municipalityKey = actualColumnNames.MUNICIPALITY;
            const addressKey = actualColumnNames.ADDRESS; 
            const providerKey = actualColumnNames.PROVIDER; 

            if (!school[latKey] || !school[lonKey]) return null;

            let lat = parseFloat(String(school[latKey]).replace(',', '.'));
            let lon = parseFloat(String(school[lonKey]).replace(',', '.'));

            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                return null;
            }

            return {
                name: school[nameKey] || 'Nome não fornecido',
                municipality: school[municipalityKey] || 'Município não fornecido',
                lat: lat,
                lon: lon,
                address: school[addressKey] || 'Endereço não fornecido',
                inep: school['INEP'] || 'INEP não fornecido',
                providerName: school[providerKey] || 'N/A', 
                vel_download: school[actualColumnNames.VEL_DOWNLOAD] || 'N/A'
            };
        }

        // displayProviderGroups foi removido

        /**
         * Renderiza os grupos de proximidade (Aba Padrão).
         * Renomeado de displayClusters para displayGroups.
         */
        function displayGroups(groups) {
            resultsContainer.innerHTML = ''; 
            
            if (groups.length === 0) {
                resultsContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow">
                    <p class="font-bold">Nenhuma escola válida encontrada.</p>
                    <p>Verifique se o arquivo possui dados e colunas de Lat/Long válidas.</p>
                </div>`;
                return;
            }

            groups.forEach((group, index) => { // Renomeado cluster para group
                const isSingleSchool = group.schools.length === 1;
                const schoolsHtml = group.schools.map((school) => `
                    <li class="p-3 border-t border-gray-100 flex justify-between items-start flex-col sm:flex-row">
                        <div class="flex-grow">
                            <span class="font-semibold text-gray-700">${school.name}</span>
                            <span class="text-xs text-gray-500 block">
                                ${school.address}, INEP: ${school.inep}
                            </span>
                        </div>
                        <button
                            onclick="window.handleProviderSearch('${school.name.replace(/'/g, "\\'")}', '${group.municipality.replace(/'/g, "\\'")}')"
                            class="mt-2 sm:mt-0 py-1 px-3 bg-blue-500 text-white font-medium rounded-full hover:bg-blue-600 transition duration-200 text-xs shadow-md"
                        >
                            Pesquisar Provedores
                        </button>
                    </li>
                `).join('');

                // Renomeado Cluster -> Grupo
                const groupTitle = isSingleSchool 
                    ? `Escola Isolada (Grupo ${index + 1})` 
                    : `Grupo ${index + 1} (${group.schools.length} Escolas)`;

                // Cor atualizada para mainBlue-500/700
                const groupCard = `
                    <div class="bg-white rounded-xl shadow-lg border-t-4 ${isSingleSchool ? 'border-gray-400' : 'border-mainBlue-500'}">
                        <div class="p-5">
                            <h2 class="text-xl font-bold ${isSingleSchool ? 'text-gray-700' : 'text-mainBlue-700'}">${groupTitle}</h2>
                            <p class="text-sm text-gray-500 mb-2">Município: <span class="font-semibold text-gray-700">${group.municipality}</span></p>
                            ${!isSingleSchool ? `<p class="text-xs text-green-600 font-medium">Estas escolas estão localizadas a menos de ${MAX_DISTANCE_KM} km de distância entre si.</p>` : ''}
                        </div>
                        <ul class="divide-y divide-gray-100">
                            ${schoolsHtml}
                        </ul>
                    </div>
                `;
                resultsContainer.innerHTML += groupCard;
            });
            
            // Texto de status atualizado
            statusMessage.textContent = `${schoolData.length} escolas processadas, resultando em ${groups.length} grupos.`;
        }

        /**
         * Função central para renderizar o conteúdo da aba ativa (agora apenas 'groups').
         */
        function renderResults() {
            if (schoolData.length === 0) {
                resultsContainer.innerHTML = `<div id="initialPrompt" class="bg-white p-6 rounded-xl shadow-lg text-center text-gray-500">
                    Carregue o arquivo XLSX para iniciar o agrupamento de escolas.
                </div>`;
                return;
            }

            displayGroups(groupGroups);
        }

        // --- Lógica de Associação e WhatsApp ---
        
        /**
         * Salva o nome do provedor associado a uma escola (mantida, mas o agrupamento por provedor não é mais exibido).
         */
        window.associateProvider = (schoolName) => {
            const providerInput = document.getElementById('providerInput');
            const provider = providerInput.value ? providerInput.value.trim() : '';

            if (!provider) {
                showMessageBox("Aviso", "Por favor, insira o nome do provedor para associar.");
                return;
            }

            const schoolToUpdate = schoolData.find(s => s.name === schoolName);

            if (schoolToUpdate) {
                schoolToUpdate.providerName = provider;
                
                // Recalcula o agrupamento principal
                groupGroups = groupSchools(schoolData, MAX_DISTANCE_KM);

                window.closeMessageBox();

                // Confirmação com o usuário
                showMessageBox(
                    "Sucesso na Associação", 
                    `A escola <strong>${schoolName}</strong> foi associada ao provedor <strong>${provider}</strong>. O dado foi salvo internamente.`
                );
                
                // Re-renderiza a visualização atual
                renderResults();
            } else {
                showMessageBox("Erro", "Não foi possível localizar a escola para atualização.");
            }
        };

        /**
         * Formata o conteúdo do texto, identificando números de telefone e adicionando links de WhatsApp.
         */
        function formatContentWithWhatsappLinks(text) {
            const phoneRegex = /(?:\+?\s*(55)\s*)?\(?(\d{2})\)?\s*(\d{4,5}[-.\s]?\d{4})\b/g;

            return text.replace(phoneRegex, (match, ddi, ddd, numberPart) => {
                let cleanNumber = '';
                cleanNumber += ddd;
                cleanNumber += numberPart.replace(/\D/g, ''); 
                
                if (!cleanNumber.startsWith('55')) {
                    cleanNumber = '55' + cleanNumber;
                }

                const waLink = `https://wa.me/${cleanNumber}`;
                
                return `${match} <a href="${waLink}" target="_blank" class="text-green-600 font-semibold hover:underline">[Iniciar Conversa]</a>`;
            });
        }


        // --- Lógica de Pesquisa de Provedores (Gemini API) ---

        /**
         * Função principal para buscar provedores de internet usando a API Gemini (com grounding).
         */
        async function handleProviderSearch(schoolName, municipality) {
            const userQuery = `Encontre provedores de internet (ISPs) ou redes de fibra óptica que atendam ou estejam próximos à área de "${municipality}" no Maranhão, Brasil. Para CADA provedor encontrado, forneça seu NOME COMPLETO e o máximo de CONTATOS possível (incluindo número de telefone, WhatsApp, Instagram, e URL do site). Apresente o resultado em texto simples, sem usar formatação Markdown (como listas, negrito ou títulos). Use quebras de linha para separar os provedores. O foco é fornecer os contatos.`;
            
            const systemPrompt = "Você é um especialista em conectividade e pesquisa de provedores de internet. Use a pesquisa na web para obter dados atualizados. Apresente os resultados em TEXTO PLANO (sem Markdown ou HTML), listando o NOME do provedor e todos os contatos encontrados (telefone, WhatsApp, Instagram, site) de forma concisa e direta, usando quebras de linha para formatar. O foco é fornecer os contatos.";

            showMessageBox(
                'Pesquisando Provedores de Internet',
                `<p>Aguarde enquanto pesquisamos provedores para a região de <strong>${municipality}</strong>, Maranhão.</p>`,
                true // Is Loading
            );

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let attempt = 0;
            let apiResponse = null;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(generateContentUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    apiResponse = await response.json();
                    break; 
                } catch (error) {
                    console.error(`Tentativa ${attempt + 1} falhou:`, error);
                    attempt++;
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        showMessageBox(
                            'Erro na Pesquisa',
                            `<p>Não foi possível realizar a pesquisa online de provedores após ${maxRetries} tentativas. Verifique sua conexão ou tente novamente mais tarde.</p>`
                        );
                        return;
                    }
                }
            }

            // Processa a resposta da API
            const candidate = apiResponse?.candidates?.[0];
            let contentText = 'Não foi possível obter uma resposta detalhada sobre provedores de internet para esta região.';
            let sourcesHtml = '';

            if (candidate && candidate.content?.parts?.[0]?.text) {
                contentText = candidate.content.parts[0].text;
                
                const formattedContent = formatContentWithWhatsappLinks(contentText);

                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); 

                    if (sources.length > 0) {
                        sourcesHtml = '<div class="mt-4 pt-4 border-t border-gray-200">';
                        sourcesHtml += '<h5 class="font-semibold text-xs text-gray-500 mb-1">Fontes de Pesquisa:</h5>';
                        sourcesHtml += '<ul class="list-disc pl-5 text-xs text-gray-500 space-y-1">';
                        sources.forEach(s => {
                            sourcesHtml += `<li><a href="${s.uri}" target="_blank" class="hover:underline text-blue-500">${s.title}</a></li>`;
                        });
                        sourcesHtml += '</ul></div>';
                    }
                }
                
                // NOVO: Formulário de Associação (Cor atualizada para mainBlue)
                const actionHtml = `
                    <div class="mt-4 p-3 bg-mainBlue-50 rounded-xl border border-mainBlue-300">
                        <label for="providerInput" class="block text-sm font-semibold text-mainBlue-700 mb-2">
                            Associar Provedor à Escola <strong>${schoolName}</strong>:
                        </label>
                        <input type="text" id="providerInput" placeholder="Digite o nome do provedor (ex: G Fibra)" 
                            class="w-full p-2 border border-mainBlue-300 rounded-lg text-gray-700 mb-2 focus:ring-mainBlue-500 focus:border-mainBlue-500">
                        <button 
                            onclick="window.associateProvider('${schoolName.replace(/'/g, "\\'")}')"
                            class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200"
                        >
                            Confirmar e Agrupar
                        </button>
                    </div>
                `;

                // Exibe o resultado final com os links de WhatsApp E o formulário de associação
                showMessageBox(
                    `Provedores para ${municipality}`,
                    `<p class="font-medium text-gray-800 mb-3">Resultado da pesquisa online para a escola <strong>${schoolName}</strong> (Município: ${municipality}):</p>
                    <div class="p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${formattedContent}</div>
                    ${sourcesHtml}`,
                    false, // Not Loading
                    actionHtml // Custom Action HTML
                );

            } else {
                showMessageBox(
                    'Erro na Pesquisa',
                    `<p>Não foi possível obter uma resposta detalhada sobre provedores de internet para esta região.</p>`
                );
            }
        }

        // Atribui a função globalmente para que o HTML do popup possa chamá-la
        window.handleProviderSearch = handleProviderSearch;


        // --- Event Listener para Carregamento de Arquivo ---

        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                statusMessage.textContent = 'Carregando e processando dados...';

                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // 1. LÊ o arquivo XLSX
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 2. CONVERTE a primeira aba para uma string CSV
                        const csvString = XLSX.utils.sheet_to_csv(worksheet); 

                        // 3. PROCESSA a string CSV usando PapaParse
                        Papa.parse(csvString, {
                            header: true,
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            encoding: "utf8",
                            complete: function(results) {
                                const rawData = results.data;
                                
                                if (rawData.length === 0) {
                                    statusMessage.textContent = 'Erro: O arquivo está vazio ou a primeira aba não contém dados válidos.';
                                    return;
                                }

                                // 4. ENCONTRA OS NOMES REAIS DAS CHAVES (Mais robusto)
                                const sampleSchool = rawData[0];
                                
                                actualColumnNames.LATITUDE = findActualKey("Lat corrigida", sampleSchool);
                                actualColumnNames.LONGITUDE = findActualKey("Long corrigida", sampleSchool);
                                actualColumnNames.NAME = findActualKey("Nome da Escola", sampleSchool);
                                actualColumnNames.MUNICIPALITY = findActualKey("Município", sampleSchool);
                                actualColumnNames.ADDRESS = findActualKey("Endereço", sampleSchool) || 'Endereço';
                                actualColumnNames.INEP = findActualKey("INEP", sampleSchool) || 'INEP';
                                actualColumnNames.VEL_DOWNLOAD = findActualKey("Veloc. (Mbps) Dowload", sampleSchool) || 'Veloc. (Mbps) Dowload';
                                actualColumnNames.PROVIDER = findActualKey("Nome do Provedor", sampleSchool) || findActualKey("Provedor", sampleSchool) || 'Provedor'; 

                                if (!actualColumnNames.LATITUDE || !actualColumnNames.LONGITUDE) {
                                    statusMessage.textContent = `Erro nos cabeçalhos: Não foi possível encontrar as colunas de Latitude e Longitude. Verifique se estão nomeadas como "Lat corrigida" e "Long corrigida" (ou similar) na primeira linha.`;
                                    console.error("Chaves necessárias não encontradas:", actualColumnNames);
                                    return;
                                }

                                // 5. Mapeia e processa os dados brutos
                                schoolData = rawData.map(processSchool).filter(s => s !== null);

                                if (schoolData.length > 0) {
                                    // 6. Executa o agrupamento e exibe
                                    groupGroups = groupSchools(schoolData, MAX_DISTANCE_KM); // Renomeado
                                    // providerGroups removido
                                    
                                    setActiveTab('groups'); // Renderiza a aba ativa
                                } else {
                                    statusMessage.textContent = 'Erro: Nenhum dado de escola válido encontrado. Verifique se as colunas de Latitude e Longitude estão preenchidas com números corretos.';
                                }
                            },
                            error: function(error) {
                                statusMessage.textContent = `Erro ao processar dados (PapaParse): ${error.message}`;
                                console.error("Papa Parse Error:", error);
                            }
                        });

                    } catch (error) {
                        statusMessage.textContent = `Erro ao ler arquivo XLSX: ${error.message}. Certifique-se de que é um arquivo XLSX/XLS válido.`;
                        console.error("XLSX Read Error:", error);
                    }
                };

                reader.readAsArrayBuffer(file);
            }
        });
        
        // Inicializa o estado da aba ao carregar
        window.onload = () => { setActiveTab('groups'); }; // Renomeado
    </script>
</body>
</html>

