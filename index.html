<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeador de Escolas</title>
    
    <!-- Configuração do Tailwind CSS com a cor principal customizada -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cor principal do projeto (mantida do código original)
                        mainBlue: {
                            50: '#eef2f7',
                            100: '#dde5ed',
                            300: '#a3b7d1',
                            500: '#274e82', // Cor especificada para interações
                            600: '#234676',
                            700: '#1e3d64',
                            800: '#193352',
                        },
                        // Cores para os cards de KPI (inspiradas no dashboard do anexo)
                        indigoAccent: '#4F46E5', // Azul/Roxo suave para Total de Escolas
                        tealAccent: '#14B8A6', // Verde-água para Grupos/Estados
                    }
                }
            }
        }
    </script>
    <style>
        /* Define a fonte Inter */
        html { font-family: 'Inter', sans-serif; }

        /* Estilo para a caixa de mensagem/modal */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.2);
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #274e82; /* mainBlue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Classes de ícones (SVGs) */
        .icon {
            width: 28px;
            height: 28px;
        }
    </style>
    <!-- Carregamento das bibliotecas JS necessárias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="message-container"></div>
    <div id="message-overlay" class="hidden message-box-overlay"></div>

    <div class="container mx-auto p-4 md:p-6 lg:p-10">
        
        <!-- HEADER (Cabeçalho principal e seletor de arquivo no estilo dashboard) -->
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-lg border-b border-gray-100">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">Mapeador de Escolas</h1>
                <p class="text-sm text-gray-500">Localize escolas agrupadas e encontre provedores de internet</p>
            </div>
            
            <div class="flex items-center space-x-4 text-sm font-medium">
                <!-- Status do Arquivo (Exibição de Escolas) -->
                <p id="fileStatusDisplay" class="text-gray-500 font-semibold hidden md:block">
                    <span id="totalSchoolsDisplay">0</span> Escolas
                </p>

                <!-- Botão de Escolha de Arquivo -->
                <input type="file" id="csvFileInput" accept=".xlsx,.xls" class="hidden" />
                <label for="csvFileInput" id="fileInputLabel" class="cursor-pointer py-2 px-4 border border-gray-300 rounded-lg text-mainBlue-700 bg-gray-50 hover:bg-mainBlue-50 transition duration-150 shadow-sm whitespace-nowrap">
                    <span id="fileNameDisplay">Escolher arquivo</span>
                    <span class="ml-2 text-gray-400">×</span>
                </label>
            </div>
        </header>

        <!-- KPI CARDS (Métricas principais) -->
        <div id="kpi-cards" class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Card 1: Total de Escolas (Ícone atualizado para o School Icon) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100/50">
                <p class="text-3xl font-bold text-indigoAccent" id="kpiTotalSchools">0</p>
                <p class="text-sm text-gray-500 mb-4">Total de Escolas</p>
                <!-- Icone de Escola (SVG Base64 fornecido pelo usuário) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon text-indigoAccent opacity-50">
                    <path d="M14 21v-3a2 2 0 0 0-4 0v3"/>
                    <path d="M18 5v16"/>
                    <path d="m4 6 7.106-3.79a2 2 0 0 1 1.788 0L20 6"/>
                    <path d="m6 11-3.52 2.147a1 1 0 0 0-.48.854V19a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5a1 1 0 0 0-.48-.853L18 11"/>
                    <path d="M6 5v16"/>
                    <circle cx="12" cy="9" r="2"/>
                </svg>
            </div>

            <!-- Card 2: Grupos/Clusters -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-teal-100/50">
                <p class="text-3xl font-bold text-tealAccent" id="kpiNumGroups">0</p>
                <p class="text-sm text-gray-500 mb-4">Grupos (5km)</p>
                <!-- Icone de Agrupamento (PlaceHolder SVG) -->
                <svg class="icon text-tealAccent opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7v10m0-10H4M4 7v10m0 0l6-6m-6 6l6 6m10-6l-6-6m6 6l-6 6"></path></svg>
            </div>

            <!-- Card 3: Estados (ou Municípios Únicos, pela simplicidade do dataset) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-teal-100/50">
                <p class="text-3xl font-bold text-tealAccent" id="kpiNumStates">0</p>
                <p class="text-sm text-gray-500 mb-4">Municípios Únicos</p>
                <!-- Icone de Localização (PlaceHolder SVG) -->
                <svg class="icon text-tealAccent opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.997 1.997 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </div>

            <!-- Card 4: Mbps Médio -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <p class="text-3xl font-bold text-gray-700" id="kpiAvgMbps">0</p>
                <p class="text-sm text-gray-500 mb-4">Mbps Médio (Download)</p>
                <!-- Icone de Wi-Fi (PlaceHolder SVG) -->
                <svg class="icon text-gray-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20a8 8 0 01-8-8 8 8 0 018-8 8 8 0 018 8 8 8 0 01-8 8zm0-14v2m0 10v2m6-6h2m-14 0H4"></path></svg>
            </div>
        </div>
        
        <!-- FILTROS (Estado e Município) -->
        <div id="filters" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="stateFilter" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="stateFilter" class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-mainBlue-500 focus:border-mainBlue-500">
                        <option value="Todos">Todos os Estados</option>
                        <!-- Opções populadas dinamicamente via JS -->
                    </select>
                </div>
                <div>
                    <label for="municipalityFilter" class="block text-sm font-medium text-gray-700">Município</label>
                    <select id="municipalityFilter" class="mt-1 w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-mainBlue-500 focus:border-mainBlue-500">
                        <option value="Todos">Todos os Municípios</option>
                        <!-- Opções populadas dinamicamente via JS -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Título da Seção de Resultados -->
        <div class="flex justify-between items-end mb-4">
            <h2 class="text-xl font-bold text-gray-800">Grupos de Escolas</h2>
            <p id="groupCountDisplay" class="text-sm text-gray-500">0 grupos encontrados</p>
        </div>

        <!-- CONTAINER DE RESULTADOS (Agora como grid de cards) -->
        <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div id="initialPrompt" class="bg-white p-6 rounded-xl shadow-lg text-center text-gray-500 md:col-span-full">
                Carregue o arquivo XLSX para iniciar o agrupamento de escolas.
            </div>
        </div>
    </div>

    <script type="module">
        // Variáveis de ambiente
        const apiKey = "AIzaSyAjjgVH3Jgw8_ZOAtihB699dAlJXu6zSNo";
        const generateContentUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const MAX_DISTANCE_KM = 5; // Distância máxima para considerar escolas no mesmo Grupo (5 km)

        // Referências do DOM
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const kpiTotalSchools = document.getElementById('kpiTotalSchools');
        const kpiNumGroups = document.getElementById('kpiNumGroups');
        const kpiNumStates = document.getElementById('kpiNumStates');
        const kpiAvgMbps = document.getElementById('kpiAvgMbps');
        const groupCountDisplay = document.getElementById('groupCountDisplay');
        const resultsContainer = document.getElementById('resultsContainer');
        const messageContainer = document.getElementById('message-container');
        const messageOverlay = document.getElementById('message-overlay');
        
        // Referências do DOM para filtros
        const stateFilter = document.getElementById('stateFilter');
        const municipalityFilter = document.getElementById('municipalityFilter');


        let schoolData = [];
        let groupGroups = [];
        let actualColumnNames = {};
        let filteredGroupsCache = []; // Cache para os grupos filtrados
        let allSchoolsWithState = []; // Array para escolas com estado (UF) lido do arquivo


        // --- Funções de UI (Caixa de Mensagem) ---

        /**
         * Exibe uma caixa de mensagem customizada no centro da tela.
         */
        function showMessageBox(title, content, isLoading = false, customActionHtml = '') {
            messageContainer.innerHTML = '';
            const loadingHtml = isLoading ? '<span class="loading-spinner"></span>' : '';

            const boxHtml = `
                <div class="message-box bg-white rounded-xl p-6 w-full max-w-lg">
                    <h3 class="text-xl font-bold mb-3 text-mainBlue-700 flex items-center">
                        ${loadingHtml} ${title}
                    </h3>
                    <div class="text-sm text-gray-600 mb-4 max-h-96 overflow-y-auto" id="message-content">
                        ${content}
                    </div>
                    <div id="custom-action-area">
                        ${customActionHtml}
                    </div>
                    ${isLoading ? '' : '<button onclick="window.closeMessageBox()" class="w-full py-2 px-4 bg-mainBlue-500 text-white font-semibold rounded-lg shadow-md hover:bg-mainBlue-600 transition duration-200 mt-2">Fechar</button>'}
                </div>
            `;
            messageContainer.innerHTML = boxHtml;
            messageOverlay.classList.remove('hidden');
        }

        // Função global para fechar a caixa de mensagem
        window.closeMessageBox = () => {
            messageContainer.innerHTML = '';
            messageOverlay.classList.add('hidden');
        };

        // --- Lógica de Geometria e Agrupamento (Mantida) ---

        /**
         * Calcula a distância Haversine entre dois pontos em km.
         */
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em quilômetros
            const toRad = (value) => (value * Math.PI) / 180;

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distância em km
        }

        /**
         * Agrupa as escolas por proximidade usando a distância Haversine.
         */
        function groupSchools(schools, maxDistanceKm) {
            const groups = []; 
            const schoolsCopy = [...schools]; 

            while (schoolsCopy.length > 0) {
                const currentSchool = schoolsCopy.shift(); 
                
                const newGroup = { 
                    id: groups.length + 1,
                    municipality: currentSchool.municipality,
                    schools: [currentSchool],
                    // Calcula a média de Mbps para o grupo
                    avgMbps: currentSchool.vel_download !== 'N/A' ? parseFloat(currentSchool.vel_download) : 0 
                };

                let i = 0;
                while (i < schoolsCopy.length) {
                    const candidate = schoolsCopy[i];
                    
                    const distance = haversineDistance(
                        currentSchool.lat, currentSchool.lon, 
                        candidate.lat, candidate.lon
                    );

                    if (distance <= maxDistanceKm) {
                        newGroup.schools.push(candidate);
                        schoolsCopy.splice(i, 1); 
                    } else {
                        i++; 
                    }
                }

                // Recalcula a média de Mbps do grupo
                const totalMbps = newGroup.schools.reduce((sum, s) => {
                    const mbps = s.vel_download !== 'N/A' ? parseFloat(s.vel_download) : 0;
                    return sum + mbps;
                }, 0);
                newGroup.avgMbps = newGroup.schools.length > 0 ? (totalMbps / newGroup.schools.length).toFixed(2) : 0;
                
                groups.push(newGroup);
            }

            groups.sort((a, b) => {
                if (a.municipality < b.municipality) return -1;
                if (a.municipality > b.municipality) return 1;
                return b.schools.length - a.schools.length;
            });

            return groups;
        }

        // --- Lógica de Dados e Visualização ---

        /**
         * Encontra o nome real de uma coluna.
         */
        function findActualKey(searchKey, school) {
            const keys = Object.keys(school);
            const normalizedSearchKey = searchKey.replace(/\s+/g, ' ').toLowerCase(); 

            for (const key of keys) {
                const normalizedKey = key.replace(/\s+/g, ' ').toLowerCase(); 

                if (normalizedKey.includes(normalizedSearchKey)) {
                    return key; 
                }
            }
            return null;
        }


        /**
         * Processa os dados de uma escola, garantindo que Lat/Long sejam números válidos.
         */
        function processSchool(school) {
            const latKey = actualColumnNames.LATITUDE;
            const lonKey = actualColumnNames.LONGITUDE;
            const nameKey = actualColumnNames.NAME;
            const municipalityKey = actualColumnNames.MUNICIPALITY;
            const addressKey = actualColumnNames.ADDRESS; 
            const providerKey = actualColumnNames.PROVIDER; 
            const velDownloadKey = actualColumnNames.VEL_DOWNLOAD;
            // Chave para Estado/UF
            const stateKey = actualColumnNames.STATE; 

            if (!school[latKey] || !school[lonKey]) return null;

            let lat = parseFloat(String(school[latKey]).replace(',', '.'));
            let lon = parseFloat(String(school[lonKey]).replace(',', '.'));

            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                return null;
            }
            
            // Garantir que o estado seja uma string de 2 letras ou 'NA'
            let state = (school[stateKey] && String(school[stateKey]).trim().toUpperCase().slice(0, 2)) || 'NA';
            if (!/^[A-Z]{2}$/.test(state)) {
                state = 'NA';
            }


            return {
                name: school[nameKey] || 'Nome não fornecido',
                municipality: school[municipalityKey] || 'Município não fornecido',
                state: state, // NOVO
                lat: lat,
                lon: lon,
                address: school[addressKey] || 'Endereço não fornecido',
                inep: school[actualColumnNames.INEP] || 'INEP não fornecido',
                providerName: school[providerKey] || 'N/A', 
                vel_download: school[velDownloadKey] || 'N/A'
            };
        }
        
        /**
         * Popula os filtros de Estado e Município com base nos dados carregados.
         */
        function populateFilters(schools) {
            const states = new Set();
            
            // Mapeia os dados para allSchoolsWithState, usando a propriedade 'state' já lida pelo processSchool
            allSchoolsWithState = schools;

            allSchoolsWithState.forEach(school => {
                states.add(school.state);
            });

            // Popula o filtro de Estado
            stateFilter.innerHTML = '';
            const allStatesOption = document.createElement('option');
            allStatesOption.value = 'Todos';
            allStatesOption.textContent = 'Todos os Estados';
            stateFilter.appendChild(allStatesOption);

            [...states].filter(s => s !== 'NA').sort().forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
            
            // Força a atualização do filtro de município (encerra o encadeamento aqui)
            updateMunicipalityFilter(); 
            
            // Pré-selecionar o primeiro estado encontrado ou 'Todos'
            const nonDefaultStates = [...states].filter(s => s !== 'Todos' && s !== 'NA');
            if (nonDefaultStates.length > 0) {
                 stateFilter.value = nonDefaultStates[0];
            } else {
                 stateFilter.value = 'Todos';
            }
        }
        
        /**
         * NOVO: Atualiza o filtro de Município com base no Estado selecionado.
         */
        function updateMunicipalityFilter() {
            const selectedState = stateFilter.value;
            const municipalities = new Set();
            
            // 1. Filtra as escolas para encontrar os municípios do estado selecionado
            allSchoolsWithState.forEach(school => {
                if (selectedState === 'Todos' || school.state === selectedState) {
                    municipalities.add(school.municipality);
                }
            });
            
            // 2. Popula o filtro de Município
            municipalityFilter.innerHTML = '';
            const allMuniOption = document.createElement('option');
            allMuniOption.value = 'Todos';
            allMuniOption.textContent = 'Todos os Municípios';
            municipalityFilter.appendChild(allMuniOption);
            
            [...municipalities].filter(m => m !== 'Todos').sort().forEach(municipality => {
                const option = document.createElement('option');
                option.value = municipality;
                option.textContent = municipality;
                municipalityFilter.appendChild(option);
            });
            
            // Mantém a seleção de município se possível, ou reseta para 'Todos'
            // Neste caso, vamos resetar para simplificar o fluxo de filtro
            municipalityFilter.value = 'Todos';
            
            // 3. Aplica o filtro completo após a mudança de estado/município
            filterAndRender();
        }


        /**
         * Filtra as escolas e grupos e re-renderiza o dashboard.
         */
        function filterAndRender() {
            const selectedState = stateFilter.value;
            const selectedMunicipality = municipalityFilter.value;
            
            // 1. Filtra as escolas originais com base nos filtros
            let schoolsToGroup = allSchoolsWithState.filter(school => {
                const stateMatch = selectedState === 'Todos' || school.state === selectedState;
                const municipalityMatch = selectedMunicipality === 'Todos' || school.municipality === selectedMunicipality;
                return stateMatch && municipalityMatch;
            });
            
            // 2. Recalcula o agrupamento com base nas escolas filtradas
            filteredGroupsCache = groupSchools(schoolsToGroup, MAX_DISTANCE_KM);

            // 3. Atualiza os KPIs com os dados filtrados
            updateKPIs(schoolsToGroup, filteredGroupsCache);

            // 4. Renderiza os resultados
            displayGroups(filteredGroupsCache);
        }

        /**
         * Calcula e exibe as métricas de KPI.
         */
        function updateKPIs(schools, groups) {
            const totalSchools = schools.length;
            const numGroups = groups.length;
            
            // Calcula Municípios Únicos
            const uniqueMunicipalities = new Set(schools.map(s => s.municipality)).size;
            
            // Calcula Mbps Médio
            const validMbps = schools
                .map(s => s.vel_download !== 'N/A' ? parseFloat(s.vel_download) : 0)
                .filter(mbps => mbps > 0);
                
            const avgMbps = validMbps.length > 0 
                ? (validMbps.reduce((sum, m) => sum + m, 0) / validMbps.length).toFixed(0) 
                : 0;

            // Atualiza o DOM
            kpiTotalSchools.textContent = totalSchools;
            kpiNumGroups.textContent = numGroups;
            kpiNumStates.textContent = uniqueMunicipalities; // Mantido o nome
            kpiAvgMbps.textContent = avgMbps;
            groupCountDisplay.textContent = `${numGroups} grupos encontrados`;
            document.getElementById('totalSchoolsDisplay').textContent = totalSchools;
        }

        /**
         * Renderiza os grupos de proximidade como cards.
         */
        function displayGroups(groups) {
            resultsContainer.innerHTML = ''; 
            
            if (groups.length === 0) {
                resultsContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow md:col-span-full">
                    <p class="font-bold">Nenhuma escola válida encontrada com os filtros atuais.</p>
                    <p>Tente selecionar "Todos os Estados" e "Todos os Municípios".</p>
                </div>`;
                return;
            }

            groups.forEach((group) => {
                const municipality = group.municipality;

                const actionButton = `<button
                    onclick="window.openGroupDetails(${group.id}, '${municipality.replace(/'/g, "\\'")}', ${group.avgMbps}, ${group.schools.length})"
                    class="w-full py-2 text-mainBlue-500 font-semibold rounded-lg hover:bg-mainBlue-50 transition duration-200 mt-4 text-sm border border-mainBlue-500/50"
                >
                    Clique para ver detalhes e buscar provedores
                </button>`;

                // Cartão de Resultado (Cluster Card)
                const groupCard = `
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-5 hover:shadow-xl transition-shadow duration-300">
                        <!-- Topo do Card -->
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-gray-800">${group.schools.length} Escolas Próximas</h3>
                            <span class="px-3 py-1 bg-teal-100 text-tealAccent text-xs font-semibold rounded-full">${group.schools.length}</span>
                        </div>
                        
                        <!-- Localização -->
                        <div class="flex items-center text-sm text-gray-600 mb-4">
                            <!-- Icone de Ponto (Placeholder) -->
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.997 1.997 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>${municipality}</span>
                        </div>

                        <!-- Métricas -->
                        <div class="flex justify-between items-center text-sm mb-4 border-t border-b border-gray-100 py-3">
                            <div class="flex items-center">
                                <!-- Icone de Média (Placeholder) -->
                                <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m0 0l-4-4m4 4l4-4M16 16h-4m-4 0H4"></path></svg>
                                <span>Média: <strong class="text-gray-900">${group.avgMbps}</strong> Mbps</span>
                            </div>
                            <div class="flex items-center">
                                <!-- Icone de Raio (Placeholder) -->
                                <svg class="w-4 h-4 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                <span class="text-red-600 font-semibold">Raio: ${MAX_DISTANCE_KM}km</span>
                            </div>
                        </div>

                        ${actionButton}
                    </div>
                `;
                resultsContainer.innerHTML += groupCard;
            });
        }

        // Função para abrir o modal de detalhes do grupo (novo)
        window.openGroupDetails = (groupId, municipality, avgMbps, schoolCount) => {
            // Busca o grupo no cache filtrado (garante que os detalhes correspondem ao que está sendo visto)
            const group = filteredGroupsCache.find(g => g.id === groupId); 
            if (!group) return;

            const schoolListHtml = group.schools.map(school => {
                // Encontra a escola original no dataset completo para garantir que o município de pesquisa seja o correto
                const originalSchool = allSchoolsWithState.find(s => s.name === school.name);
                const searchMunicipality = originalSchool ? originalSchool.municipality : municipality;

                return `
                <li class="p-3 bg-gray-50 rounded-lg border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <p class="font-semibold text-gray-800">${school.name} <span class="text-xs font-normal text-gray-500"> (INEP: ${school.inep})</span></p>
                        <p class="text-xs text-gray-600">Provedor: ${school.providerName}</p>
                    </div>
                    <button
                        onclick="window.handleProviderSearch('${school.name.replace(/'/g, "\\'")}', '${searchMunicipality.replace(/'/g, "\\'")}')"
                        class="mt-2 sm:mt-0 py-1 px-3 bg-blue-500 text-white font-medium rounded-full hover:bg-blue-600 transition duration-200 text-xs shadow-md whitespace-nowrap"
                    >
                        Pesquisar Provedores
                    </button>
                </li>
            `}).join('');


            const content = `
                <div class="space-y-4">
                    <div class="bg-mainBlue-50 p-4 rounded-lg">
                        <p class="text-xs text-mainBlue-700 font-semibold">Resumo do Grupo:</p>
                        <p class="text-sm">Município: <strong>${municipality}</strong></p>
                        <p class="text-sm">Escolas: <strong>${schoolCount}</strong></p>
                        <p class="text-sm">Média de Mbps: <strong>${avgMbps}</strong></p>
                    </div>
                    <p class="font-bold text-gray-700">Ações:</p>
                    <ul class="space-y-2">
                        ${schoolListHtml}
                    </ul>
                </div>
            `;

            showMessageBox(
                `Detalhes do Grupo de Proximidade ${groupId}`,
                content
            );
        };


        // --- Lógica de Associação e WhatsApp (Mantida) ---
        
        /**
         * Salva o nome do provedor associado a uma escola.
         */
        window.associateProvider = (schoolName) => {
            const providerInput = document.getElementById('providerInput');
            const provider = providerInput.value ? providerInput.value.trim() : '';

            if (!provider) {
                showMessageBox("Aviso", "Por favor, insira o nome do provedor para associar.");
                return;
            }

            // Atualiza o dado na fonte original
            const schoolToUpdate = schoolData.find(s => s.name === schoolName);

            if (schoolToUpdate) {
                schoolToUpdate.providerName = provider;
                
                // Recalcula o agrupamento principal
                groupGroups = groupSchools(schoolData, MAX_DISTANCE_KM);
                
                window.closeMessageBox();

                showMessageBox(
                    "Sucesso na Associação", 
                    `A escola <strong>${schoolName}</strong> foi associada ao provedor <strong>${provider}</strong>. O dashboard será atualizado.`
                );
                
                // Re-renderiza a visualização filtrada atual
                filterAndRender();
            } else {
                showMessageBox("Erro", "Não foi possível localizar a escola para atualização.");
            }
        };

        /**
         * Formata o conteúdo do texto, identificando números de telefone e adicionando links de WhatsApp.
         */
        function formatContentWithWhatsappLinks(text) {
            const phoneRegex = /(?:\+?\s*(55)\s*)?\(?(\d{2})\)?\s*(\d{4,5}[-.\s]?\d{4})\b/g;

            // Substitui quebras de linha por <br> e depois procura por telefones
            const htmlText = text.replace(/\n/g, '<br>');

            return htmlText.replace(phoneRegex, (match, ddi, ddd, numberPart) => {
                let cleanNumber = '';
                cleanNumber += ddd;
                cleanNumber += numberPart.replace(/\D/g, ''); 
                
                if (!cleanNumber.startsWith('55')) {
                    cleanNumber = '55' + cleanNumber;
                }

                const waLink = `https://wa.me/${cleanNumber}`;
                
                return `${match} <a href="${waLink}" target="_blank" class="text-green-600 font-semibold hover:underline">[WhatsApp]</a>`;
            });
        }


        // --- Lógica de Pesquisa de Provedores (Gemini API) (Mantida) ---

        /**
         * Função principal para buscar provedores de internet usando a API Gemini (com grounding).
         */
        async function handleProviderSearch(schoolName, municipality) {
            // A query do Gemini ainda foca no Maranhão como default, pode ser ajustada se houver mais estados na base
            const userQuery = `Encontre provedores de internet (ISPs) ou redes de fibra óptica que atendam ou estejam próximos à área de "${municipality}", Brasil. Para CADA provedor encontrado, forneça seu NOME COMPLETO e o máximo de CONTATOS possível (incluindo número de telefone, WhatsApp, Instagram, e URL do site). Apresente o resultado em texto simples, sem usar formatação Markdown (como listas, negrito ou títulos). Use quebras de linha para separar os provedores. O foco é fornecer os contatos.`;
            
            const systemPrompt = "Você é um especialista em conectividade e pesquisa de provedores de internet. Use a pesquisa na web para obter dados atualizados. Apresente os resultados em TEXTO PLANO (sem Markdown ou HTML), listando o NOME do provedor e todos os contatos encontrados (telefone, WhatsApp, Instagram, site) de forma concisa e direta, usando quebras de linha para formatar. O foco é fornecer os contatos.";

            showMessageBox(
                'Pesquisando Provedores de Internet',
                `<p>Aguarde enquanto pesquisamos provedores para a região de <strong>${municipality}</strong>.</p>`,
                true // Is Loading
            );

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let attempt = 0;
            let apiResponse = null;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(generateContentUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    apiResponse = await response.json();
                    break; 
                } catch (error) {
                    console.error(`Tentativa ${attempt + 1} falhou:`, error);
                    attempt++;
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        showMessageBox(
                            'Erro na Pesquisa',
                            `<p>Não foi possível realizar a pesquisa online de provedores após ${maxRetries} tentativas. Verifique sua conexão ou tente novamente mais tarde.</p>`
                        );
                        return;
                    }
                }
            }

            // Processa a resposta da API
            const candidate = apiResponse?.candidates?.[0];
            let contentText = 'Não foi possível obter uma resposta detalhada sobre provedores de internet para esta região.';
            let sourcesHtml = '';

            if (candidate && candidate.content?.parts?.[0]?.text) {
                contentText = candidate.content.parts[0].text;
                
                const formattedContent = formatContentWithWhatsappLinks(contentText);

                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); 

                    if (sources.length > 0) {
                        sourcesHtml = '<div class="mt-4 pt-4 border-t border-gray-200">';
                        sourcesHtml += '<h5 class="font-semibold text-xs text-gray-500 mb-1">Fontes de Pesquisa:</h5>';
                        sourcesHtml += '<ul class="list-disc pl-5 text-xs text-gray-500 space-y-1">';
                        sources.forEach(s => {
                            sourcesHtml += `<li><a href="${s.uri}" target="_blank" class="hover:underline text-blue-500">${s.title}</a></li>`;
                        });
                        sourcesHtml += '</ul></div>';
                    }
                }
                
                // Formulário de Associação
                const actionHtml = `
                    <div class="mt-4 p-3 bg-mainBlue-50 rounded-xl border border-mainBlue-300">
                        <label for="providerInput" class="block text-sm font-semibold text-mainBlue-700 mb-2">
                            Associar Provedor à Escola <strong>${schoolName}</strong>:
                        </label>
                        <input type="text" id="providerInput" placeholder="Digite o nome do provedor (ex: G Fibra)" 
                            class="w-full p-2 border border-mainBlue-300 rounded-lg text-gray-700 mb-2 focus:ring-mainBlue-500 focus:border-mainBlue-500">
                        <button 
                            onclick="window.associateProvider('${schoolName.replace(/'/g, "\\'")}')"
                            class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200"
                        >
                            Confirmar e Agrupar
                        </button>
                    </div>
                `;

                // Exibe o resultado final com os links de WhatsApp E o formulário de associação
                showMessageBox(
                    `Provedores para ${municipality}`,
                    `<p class="font-medium text-gray-800 mb-3">Resultado da pesquisa online para a escola <strong>${schoolName}</strong> (Município: ${municipality}):</p>
                    <div class="p-3 bg-gray-50 rounded-lg whitespace-pre-wrap text-left">${formattedContent}</div>
                    ${sourcesHtml}`,
                    false, // Not Loading
                    actionHtml // Custom Action HTML
                );

            } else {
                showMessageBox(
                    'Erro na Pesquisa',
                    `<p>Não foi possível obter uma resposta detalhada sobre provedores de internet para esta região.</p>`
                );
            }
        }

        // Atribui as funções globalmente para que o HTML do popup possa chamá-las
        window.handleProviderSearch = handleProviderSearch;
        window.renderResults = filterAndRender; // Função wrapper
        
        // --- Event Listener para Carregamento de Arquivo (Atualizado) ---

        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = 'Processando...';
                
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // 1. LÊ o arquivo XLSX
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 2. CONVERTE a primeira aba para uma string CSV
                        const csvString = XLSX.utils.sheet_to_csv(worksheet); 

                        // 3. PROCESSA a string CSV usando PapaParse
                        Papa.parse(csvString, {
                            header: true,
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            encoding: "utf8",
                            complete: function(results) {
                                const rawData = results.data;
                                
                                if (rawData.length === 0) {
                                    fileNameDisplay.textContent = 'Erro: Arquivo vazio.';
                                    return;
                                }

                                // 4. ENCONTRA OS NOMES REAIS DAS CHAVES (Mais robusto)
                                const sampleSchool = rawData[0];
                                
                                actualColumnNames.LATITUDE = findActualKey("Lat corrigida", sampleSchool);
                                actualColumnNames.LONGITUDE = findActualKey("Long corrigida", sampleSchool);
                                actualColumnNames.NAME = findActualKey("Nome da Escola", sampleSchool);
                                actualColumnNames.MUNICIPALITY = findActualKey("Município", sampleSchool);
                                actualColumnNames.STATE = findActualKey("UF", sampleSchool) || findActualKey("Estado", sampleSchool) || 'UF'; // Procura por UF ou Estado
                                actualColumnNames.ADDRESS = findActualKey("Endereço", sampleSchool) || 'Endereço';
                                actualColumnNames.INEP = findActualKey("INEP", sampleSchool) || 'INEP';
                                actualColumnNames.VEL_DOWNLOAD = findActualKey("Veloc. (Mbps) Dowload", sampleSchool) || 'Veloc. (Mbps) Dowload';
                                actualColumnNames.PROVIDER = findActualKey("Nome do Provedor", sampleSchool) || findActualKey("Provedor", sampleSchool) || 'Provedor'; 

                                if (!actualColumnNames.LATITUDE || !actualColumnNames.LONGITUDE) {
                                    fileNameDisplay.textContent = `Erro: Colunas Lat/Long não encontradas.`;
                                    showMessageBox("Erro de Colunas", "Não foi possível encontrar as colunas de Latitude e Longitude (esperado: 'Lat corrigida' e 'Long corrigida' ou similar) na primeira linha.");
                                    return;
                                }
                                
                                if (!actualColumnNames.STATE) { // Verifica se a coluna UF/Estado foi encontrada
                                     showMessageBox("Aviso", "A coluna de UF/Estado não foi identificada. O filtro de estado pode não funcionar corretamente. Verifique se o cabeçalho é 'UF' ou 'Estado'.");
                                }


                                // 5. Mapeia e processa os dados brutos
                                schoolData = rawData.map(processSchool).filter(s => s !== null);

                                if (schoolData.length > 0) {
                                    // 6. Executa o agrupamento inicial
                                    groupGroups = groupSchools(schoolData, MAX_DISTANCE_KM);
                                    
                                    // Popula os filtros e re-renderiza
                                    populateFilters(schoolData); 
                                    fileNameDisplay.textContent = file.name;
                                    filterAndRender(); // Filtra (inicialmente, todos) e exibe os resultados
                                } else {
                                    fileNameDisplay.textContent = 'Erro: Sem dados válidos.';
                                    showMessageBox("Erro de Dados", "Nenhum dado de escola válido encontrado. Verifique se as colunas de Latitude e Longitude estão preenchidas com números corretos.");
                                }
                            },
                            error: function(error) {
                                fileNameDisplay.textContent = `Erro: ${error.message}`;
                                console.error("Papa Parse Error:", error);
                            }
                        });

                    } catch (error) {
                        fileNameDisplay.textContent = `Erro ao ler XLSX: ${error.message}`;
                        console.error("XLSX Read Error:", error);
                    }
                };

                reader.readAsArrayBuffer(file);
            }
        });
        
        // --- Event Listeners para Filtros (Atualizado para filtro encadeado) ---
        // Quando o estado muda, atualiza os municípios antes de renderizar
        stateFilter.addEventListener('change', updateMunicipalityFilter); 
        // Quando o município muda, apenas renderiza com o novo filtro
        municipalityFilter.addEventListener('change', filterAndRender);
        
        // Inicializa o estado dos KPIs
        window.onload = () => { updateKPIs([], []); };
    </script>
</body>
</html>
